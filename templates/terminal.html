<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terminal - SysMonitor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-green: #3fb950;
            --accent-red: #da3633;
            --accent-blue: #58a6ff;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            transition: all 0.2s;
        }
        
        .btn-back {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .btn-back:hover { background: var(--border-color); }
        
        .title {
            flex: 1;
            font-weight: 600;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }
        .status.connected { background: #238636; color: white; }
        .status.disconnected { background: var(--accent-red); color: white; }
        
        .font-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .font-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 4px;
        }
        .font-btn:hover { background: var(--border-color); color: var(--text-primary); }
        
        .icon {
            display: inline-block;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        .title-icon {
            width: 20px;
            height: 20px;
        }
        
        .font-size {
            color: var(--accent-blue);
            font-size: 12px;
            min-width: 35px;
            text-align: center;
        }
        
        .terminal-container {
            flex: 1;
            padding: 8px;
            background: var(--bg-primary);
            overflow: hidden;
            position: relative;
        }
        
        #terminal {
            height: 100%;
            width: 100%;
        }
        
        .xterm {
            height: 100%;
            padding: 8px;
        }
        
        .xterm-viewport {
            overflow-y: auto !important;
        }
        
        /* IME Input styling for Telex */
        .xterm .xterm-helper-textarea {
            position: absolute;
            opacity: 0;
            left: -9999em;
            top: 0;
            width: 0;
            height: 0;
            z-index: -9999;
            white-space: pre;
            word-wrap: normal;
            overflow: hidden;
            /* Important for Telex/Vietnamese input */
            font-family: 'JetBrains Mono', 'Noto Sans Mono', monospace !important;
        }
        
        /* Scrollbar styling */
        .xterm-viewport::-webkit-scrollbar {
            width: 10px;
        }
        .xterm-viewport::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }
        .xterm-viewport::-webkit-scrollbar-thumb {
            background: #484f58;
            border-radius: 5px;
        }
        .xterm-viewport::-webkit-scrollbar-thumb:hover {
            background: #6e7681;
        }
        
        /* IME composition styling */
        .ime-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            display: none;
            z-index: 1000;
        }
        
        .ime-status.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        /* Mobile Control Bar */
        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 8px 12px;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 100;
            flex-wrap: wrap;
        }
        
        .control-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            min-height: 44px;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .control-btn:active {
            background: var(--border-color);
            transform: scale(0.95);
        }
        
        .control-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }
        
        .control-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .control-group {
            display: flex;
            gap: 4px;
            background: var(--bg-primary);
            padding: 4px;
            border-radius: 8px;
        }
        
        .terminal-container {
            flex: 1;
            padding: 8px;
            padding-bottom: 80px;
            background: var(--bg-primary);
            overflow: hidden;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .header { padding: 8px 12px; flex-wrap: wrap; }
            .title { order: -1; width: 100%; margin-bottom: 8px; }
            .btn { padding: 6px 10px; font-size: 12px; }
            .control-btn { padding: 8px 12px; min-width: 40px; min-height: 40px; font-size: 12px; }
        }
        
        @media (min-width: 1024px) {
            .control-bar { display: none; }
            .terminal-container { padding-bottom: 8px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="btn btn-back">
            <svg class="icon" viewBox="0 0 16 16" width="16" height="16" fill="currentColor">
                <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
            </svg>
            Dashboard
        </a>
        <div class="title">
            <svg class="icon title-icon" viewBox="0 0 16 16" width="20" height="20" fill="currentColor">
                <path d="M11 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h6zM5 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H5z"/>
                <path d="M8 14a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
            </svg>
            <span>Terminal</span>
        </div>
        <div class="font-controls">
            <button class="font-btn" onclick="changeFontSize(-1)">A-</button>
            <span class="font-size" id="fontSize">16</span>
            <button class="font-btn" onclick="changeFontSize(1)">A+</button>
        </div>
        <span class="status" id="status">Connecting...</span>
    </div>
    
    <div class="terminal-container">
        <div id="terminal"></div>
    </div>
    
    <!-- Mobile Control Bar -->
    <div class="control-bar">
        <button class="control-btn" id="ctrlBtn" onclick="toggleCtrl()">Ctrl</button>
        <button class="control-btn" onclick="sendKey('\t')">Tab</button>
        <button class="control-btn" onclick="sendKey('\u001b')">Esc</button>
        <div class="control-group">
            <button class="control-btn" onclick="sendKey('\u001b[A')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 19V5M5 12l7-7 7 7"/>
                </svg>
            </button>
            <button class="control-btn" onclick="sendKey('\u001b[B')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12l7 7 7-7"/>
                </svg>
            </button>
            <button class="control-btn" onclick="sendKey('\u001b[D')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <button class="control-btn" onclick="sendKey('\u001b[C')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- IME Status indicator for Telex/Vietnamese input -->
    <div class="ime-status" id="imeStatus">
        <svg class="icon" viewBox="0 0 16 16" width="14" height="14" fill="currentColor">
            <path d="M14 5a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v1zm-4 0a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v1zm-4 0a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v1z"/>
            <path d="M0 3a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2.5a.5.5 0 0 0 0 1H13a1 1 0 0 1 1 1v1a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1v-1a1 1 0 0 1 1-1h1.5a.5.5 0 0 0 0-1H2a2 2 0 0 1-2-2V3zm2-1a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1H2z"/>
        </svg>
        Typing...
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    
    <script>
        let term = null;
        let ws = null;
        let fitAddon = null;
        let currentFontSize = parseInt(localStorage.getItem('terminalFontSize')) || 16;
        let isComposing = false;
        let compositionBuffer = '';
        let ctrlActive = false;
        
        // Update font size display
        document.getElementById('fontSize').textContent = currentFontSize;
        
        function initTerminal() {
            term = new Terminal({
                cursorBlink: true,
                cursorStyle: 'bar',
                fontSize: currentFontSize,
                // Use Noto Sans Mono for better Vietnamese character support
                fontFamily: '"Noto Sans Mono", "JetBrains Mono", "Fira Code", "SF Mono", Monaco, monospace',
                fontWeight: '400',
                fontWeightBold: '500',
                letterSpacing: 0,
                lineHeight: 1.2,
                scrollback: 5000,
                // IME/Unicode settings for Telex support
                allowProposedApi: true,
                unicodeVersion: '11',
                convertEol: true,
                tabStopWidth: 4,
                // Screen reader support helps with IME
                screenReaderMode: false,
                // Disable bell for better IME experience
                bellStyle: 'none',
                // Enable Windows mode for better compatibility
                windowsMode: false,
                theme: {
                    background: '#0d1117',
                    foreground: '#c9d1d9',
                    cursor: '#58a6ff',
                    cursorAccent: '#0d1117',
                    selection: 'rgba(88, 166, 255, 0.3)',
                    black: '#484f58',
                    red: '#ff7b72',
                    green: '#3fb950',
                    yellow: '#d29922',
                    blue: '#58a6ff',
                    magenta: '#bc8cff',
                    cyan: '#39c5cf',
                    white: '#b1bac4',
                    brightBlack: '#6e7681',
                    brightRed: '#ffa198',
                    brightGreen: '#56d364',
                    brightYellow: '#e3b341',
                    brightBlue: '#79c0ff',
                    brightMagenta: '#d2a8ff',
                    brightCyan: '#56d4dd',
                    brightWhite: '#f0f6fc'
                }
            });
            
            fitAddon = new FitAddon.FitAddon();
            const webLinksAddon = new WebLinksAddon.WebLinksAddon();
            
            term.loadAddon(fitAddon);
            term.loadAddon(webLinksAddon);
            
            term.open(document.getElementById('terminal'));
            fitAddon.fit();
            
            // Connect WebSocket
            connectWebSocket();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                fitAddon.fit();
                sendResize();
            });
            
            // Setup IME handling for Telex/Vietnamese input
            setupIMEHandling();
            
            // Handle input with IME awareness
            term.onData(data => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // Don't send data during composition - let IME handle it
                    if (!isComposing) {
                        ws.send(data);
                    }
                }
            });
            
            // Focus terminal
            term.focus();
            
            // Setup composition event listeners on the textarea
            setupCompositionListeners();
        }
        
        function setupIMEHandling() {
            // Get the textarea element that xterm uses for input
            const textarea = term.textarea;
            if (!textarea) {
                // Retry after a short delay if textarea not ready
                setTimeout(setupIMEHandling, 100);
                return;
            }
            
            // Enable composition events
            textarea.addEventListener('compositionstart', onCompositionStart);
            textarea.addEventListener('compositionupdate', onCompositionUpdate);
            textarea.addEventListener('compositionend', onCompositionEnd);
            
            // Handle input event for immediate character processing
            textarea.addEventListener('input', onInput);
            
            // Set proper attributes for IME
            textarea.setAttribute('autocapitalize', 'off');
            textarea.setAttribute('autocomplete', 'off');
            textarea.setAttribute('autocorrect', 'off');
            textarea.setAttribute('spellcheck', 'false');
            textarea.setAttribute('inputmode', 'text');
        }
        
        function setupCompositionListeners() {
            // Alternative method: poll for textarea if not immediately available
            const checkTextarea = setInterval(() => {
                if (term.textarea) {
                    clearInterval(checkTextarea);
                    setupIMEHandling();
                }
            }, 50);
            
            // Stop checking after 5 seconds
            setTimeout(() => clearInterval(checkTextarea), 5000);
        }
        
        function onCompositionStart(e) {
            isComposing = true;
            compositionBuffer = '';
            showIMEStatus(true);
            console.log('IME Composition started');
        }
        
        function onCompositionUpdate(e) {
            if (e.data) {
                compositionBuffer = e.data;
            }
        }
        
        function onCompositionEnd(e) {
            isComposing = false;
            showIMEStatus(false);
            
            // Send the final composed text
            if (e.data && ws && ws.readyState === WebSocket.OPEN) {
                // Convert to UTF-8 bytes and send
                const encoder = new TextEncoder();
                const bytes = encoder.encode(e.data);
                ws.send(bytes);
            }
            
            compositionBuffer = '';
            console.log('IME Composition ended:', e.data);
        }
        
        function onInput(e) {
            // Handle normal input (non-composition)
            if (!isComposing && e.data) {
                // Input event fired outside of composition (e.g., direct keypress)
            }
        }
        
        function showIMEStatus(show) {
            const status = document.getElementById('imeStatus');
            if (show) {
                status.classList.add('active');
            } else {
                status.classList.remove('active');
            }
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/terminal`;
            
            ws = new WebSocket(wsUrl);
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = () => {
                updateStatus('connected', 'Connected');
                sendResize();
                term.focus();
            };
            
            ws.onmessage = (event) => {
                const data = new Uint8Array(event.data);
                term.write(data);
            };
            
            ws.onclose = () => {
                updateStatus('disconnected', 'Disconnected');
                term.write('\r\n\x1b[31m[Connection closed. Refresh to reconnect]\x1b[0m\r\n');
            };
            
            ws.onerror = (error) => {
                updateStatus('disconnected', 'Error');
                console.error('WebSocket error:', error);
            };
        }
        
        function sendResize() {
            if (ws && ws.readyState === WebSocket.OPEN && term) {
                const dims = fitAddon.proposeDimensions();
                if (dims) {
                    ws.send(JSON.stringify({ cols: dims.cols, rows: dims.rows }));
                }
            }
        }
        
        function updateStatus(type, text) {
            const status = document.getElementById('status');
            status.textContent = text;
            status.className = 'status ' + type;
        }
        
        function changeFontSize(delta) {
            currentFontSize = Math.max(10, Math.min(24, currentFontSize + delta));
            document.getElementById('fontSize').textContent = currentFontSize;
            localStorage.setItem('terminalFontSize', currentFontSize);
            
            if (term) {
                term.options.fontSize = currentFontSize;
                fitAddon.fit();
                sendResize();
                term.focus();
            }
        }
        
        // Mobile control functions
        function toggleCtrl() {
            ctrlActive = !ctrlActive;
            const btn = document.getElementById('ctrlBtn');
            if (ctrlActive) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            term.focus();
        }
        
        function sendKey(key) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            
            if (ctrlActive) {
                // If Ctrl is active, send Ctrl+key combination
                const ctrlKey = String.fromCharCode(key.charCodeAt(0) & 0x1f);
                ws.send(new TextEncoder().encode(ctrlKey));
                // Turn off Ctrl after use
                ctrlActive = false;
                document.getElementById('ctrlBtn').classList.remove('active');
            } else {
                // Send key normally
                ws.send(new TextEncoder().encode(key));
            }
            term.focus();
        }
        
        // Handle paste events for better Unicode support
        document.addEventListener('paste', (e) => {
            if (term && document.activeElement === term.textarea) {
                e.preventDefault();
                const text = e.clipboardData.getData('text');
                if (text && ws && ws.readyState === WebSocket.OPEN) {
                    const encoder = new TextEncoder();
                    ws.send(encoder.encode(text));
                }
            }
        });
        
        // Initialize on load
        initTerminal();
        
        // Re-setup IME handling after a short delay to ensure xterm is fully initialized
        setTimeout(setupIMEHandling, 500);
    </script>
</body>
</html>
